#!/bin/bash

[ ! "$OPENSIM" ] && OPENSIM=core/opensim
[ ! "$PGM" ] && PGM=$(basename "$0")
[ ! "$TMP" ] && TMP=/tmp/$PGM.$$

if ! which realpath >/dev/null; then
  realpath() {
    readlink -f "$@" 2>/dev/null && return
    cd "$@" 2>/dev/null && pwd -P && return
  }
fi

# echo ":$PATH:" | grep -q ":$BINDIR:" || export PATH=$PATH:$BINDIR
# [ ! "$LIB" ] && LIB=$BASEDIR/lib
BINDIR=$(dirname $(realpath "$0"))
BASEDIR=$(dirname "$BINDIR")
[ ! "$CONTRIB" ] && CONTRIB=$BASEDIR/contrib
. $CONTRIB/bash-helpers/helpers || echo "$PGM: Missing helpers library, run install.sh"

LIB=$BASEDIR/lib
VAR=$BASEDIR/var
LOGS=$VAR/logs
CACHE=$VAR/cache
DATA=$VAR/data
SRC=$BASEDIR/src
CORE=$BASEDIR/core

for etc in $BASEDIR/etc /etc/opensim ~/etc/opensim
do
    [ -d "$etc" ] && ETC=$etc
    [ -f "$etc/opensim.conf" ] && . $ETC/opensim.conf 2>/dev/null
done

OSBIN=$(
ls $OSBINDIR/bin/OpenSim.exe 2>/dev/null \
|| ls $CORE/*/bin/OpenSim.exe 2>/dev/null | tail -1
)
[ "$OSBIN" ] \
&& log "$OSBIN found" && OSBINDIR=$(dirname $OSBIN) && OSDIR=$(dirname $OSBINDIR)\
|| log 1 "OpenSim.exe not found, run install.sh"

osConsole() {
  [ ! "$2" ] && return
  osInstance=$1
  shift
  osCommand="$@"
  lr=$(printf "\n\b")
  pre=$(printf "\n\b")
  screen -S $osInstance -X stuff "$(echo "$pre$osCommand$lr")"
}

cleanupIni() {
  [ "$1" ] || return
  [ -f "$1" ] || return
  cat "$1" | sed "s/^[[:blank:]]*//"
}

randomPassword() {
  < /dev/urandom tr -dc "A-Za-z0-9" | head -c32
}
